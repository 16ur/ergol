// timesheets.js (MIT license) http://wam.inrialpes.fr/timesheets/
window.EVENTS={bind:function(b,a,c){},unbind:function(b,a,c){},trigger:function(b,a){}};if(window.addEventListener){EVENTS.bind=function(b,a,c){b.addEventListener(a,c,true)};EVENTS.unbind=function(b,a,c){b.removeEventListener(a,c,true)};EVENTS.trigger=function(c,a){if(!EVENTS.eventList){EVENTS.eventList=new Array()}var b=EVENTS.eventList[a];if(!b){b=document.createEvent("Event");b.initEvent(a,true,false);EVENTS.eventList[a]=b}c.dispatchEvent(b)}}else{if(window.attachEvent){EVENTS.bind=function(c,a,f){var b=a+f;a="on"+a;if(a in c){try{c["e"+b]=f;c[b]=function(){c["e"+b](window.event)};c.attachEvent(a,c[b]);return}catch(d){}}if(!c.eventList){c.eventList=new Array()}if(!c.eventList[a]){c.eventList[a]=new Array()}c.eventList[a].push(f)};EVENTS.unbind=function(g,c,j){var f=c+j;c="on"+c;if(c in g){try{g.detachEvent(c,g[f]);g[f]=null;g["e"+f]=null;return}catch(h){}}if(!g||!g.eventList||!g.eventList[c]){return}var d=g.eventList[c];var a=d.length;for(var b=0;b<a;b++){if(d[b]==j){d.slice(b,1);return}}};EVENTS.trigger=function(g,c){c="on"+c;if(c in g){try{g.fireEvent(c);return}catch(h){}}var f={};f.target=g;f.srcElement=g;if(!g||!g.eventList||!g.eventList[c]){return}var d=g.eventList[c];var a=d.length;for(var b=0;b<a;b++){d[b].call(g,f)}}}}EVENTS.onHashChange=function(b){if("onhashchange" in window){EVENTS.bind(window,"hashchange",b)}else{var a="";window.setInterval(function(){if(a!=window.location.hash){a=window.location.hash;b()}},250)}};EVENTS.onDOMReady=function(a){if(window.addEventListener){window.addEventListener("DOMContentLoaded",a,true)}else{EVENTS.bind(window,"load",a)}};EVENTS.onSMILReady=function(a){EVENTS.bind(window,"SMILContentLoaded",a)};(function(){var DEBUG=true;function consoleLog(message){if(DEBUG&&(typeof(console)=="object")){console.log(message)}}var CSSQUERY={timeContainer:"*[data-timecontainer], *[timeContainer], par, seq, excl",extTimesheets:"link[rel=timesheet]",parTimeNodes:""};var TIMERATE=40;var OLDIE=(window.addEventListener)?false:true;if(OLDIE){if(!Array.indexOf){Array.prototype.indexOf=function(obj){for(var i=0;i<this.length;i++){if(this[i]==obj){return i}}return -1}}if(!Date.now){Date.now=function(){var timestamp=new Date();return timestamp.getTime()}}if(window.Sizzle){document.querySelectorAll=function(cssQuery){return Sizzle(cssQuery)}}else{if(window.jQuery){document.querySelectorAll=function(cssQuery){return $(cssQuery)}}else{if(window.$$){document.querySelectorAll=function(cssQuery){return $$(cssQuery)}}else{if(window.dojo){document.querySelectorAll=function(cssQuery){return dojo.query(cssQuery)}}else{if(window.Ext){document.querySelectorAll=function(cssQuery){return Ext.select(cssQuery)}}else{if(window.YAHOO){document.querySelectorAll=function(cssQuery){return YAHOO.util.Selector.query(cssQuery)}}else{if(!document.querySelectorAll){document.querySelectorAll=function(cssQuery){var results=new Array();if(/^#[^\s]+$/.test(cssQuery)){var target=document.getElementById(cssQuery.substring(1));if(target){results.push(target)}}else{if(/^[a-z]+$/i.test(cssQuery)){results=document.getElementsByTagName(cssQuery)}else{if(cssQuery==CSSQUERY.extTimesheets){var links=document.getElementsByTagName("link");for(var i=0;i<links.length;i++){if(links[i].rel.toLowerCase()=="timesheet"){results.push(links[i])}}}else{if(cssQuery==CSSQUERY.timeContainer){var tmp=document.getElementsByTagName("*");var re=/^(par|seq|excl)$/i;for(var i=0;i<tmp.length;i++){if(re.test(tmp[i].nodeName)||tmp[i].getAttribute("data-timecontainer")||tmp[i].getAttribute("timeContainer")){results.push(tmp[i])}}}}}}return results}}}}}}}}document.querySelector=function(cssQuery){var results=document.querySelectorAll(cssQuery);if(results&&results.length){return results[0]}else{return null}}}function checkHash(){var container=null;var targetElement=null;var targetContainer=null;var time=NaN;var hash=document.location.hash;if(hash.length){consoleLog("new hash: "+hash);var targetID=hash.substr(1).replace(/\&.*$/,"");consoleLog("targetID: "+targetID);targetElement=document.getElementById(targetID);if(!targetElement){targetElement=document.getElementById(targetID.substr(1))}if(targetElement&&targetElement.parentNode){container=targetElement.parentNode.timing}if(targetElement.timing&&targetElement.timing.timeContainer){targetContainer=targetElement.timing;var tmp=hash.split("&");for(var i=0;i<tmp.length;i++){if(/^t=.*/i.test(tmp[i])){time=targetContainer.parseTime(tmp[i].substr(2).replace(/,.*$/,""));break}}}}if(!targetElement){return}var containers=new Array();var indexes=new Array();var element=targetElement;while(container){var index=container.timeNodes.indexOf(element);for(var index=0;index<container.timeNodes.length;index++){if(container.timeNodes[index].target==element){consoleLog("target found: "+element.nodeName+"#"+element.id);if(!container.timeNodes[index].isActive()){containers.push(container);indexes.push(index)}break}}element=container.getNode();container=container.parentNode}for(var i=containers.length-1;i>=0;i--){containers[i].selectIndex(indexes[i])}if(targetContainer&&!isNaN(time)){targetContainer.setTime(time);consoleLog(targetContainer.getNode().nodeName+" time: "+time)}if(targetElement.scrollIntoViewIfNeeded!=undefined){targetElement.scrollIntoViewIfNeeded()}else{var tabIndex=targetElement.tabIndex;targetElement.tabIndex=0;targetElement.focus();targetElement.blur();targetElement.tabIndex=tabIndex}}EVENTS.onSMILReady(function(){consoleLog("SMIL data parsed, starting 'hashchange' event listener.");checkHash();EVENTS.onHashChange(checkHash)});function parseTimeContainerNode(node){if(!node){return}if(!node.timing){consoleLog("Main time container found: "+node.nodeName);consoleLog(node);var smilPlayer=new smilTimeElement(node);smilPlayer.show()}else{consoleLog("Child time container found: "+node.nodeName)}}function parseTimesheetNode(timesheetNode){var containers=timesheetNode.childNodes;for(var i=0;i<containers.length;i++){if(containers[i].nodeType==1){parseTimeContainerNode(containers[i])}}}function parseAllTimeContainers(){var allTimeContainers=document.querySelectorAll(CSSQUERY.timeContainer);for(var i=0;i<allTimeContainers.length;i++){parseTimeContainerNode(allTimeContainers[i])}var timesheets=document.querySelectorAll(CSSQUERY.extTimesheets);var tsLength=timesheets.length;var tsParsed=0;function CountTimesheets(){if(++tsParsed>tsLength){EVENTS.unbind(document,"SMILTimesheetLoaded",CountTimesheets);EVENTS.trigger(window,"SMILContentLoaded")}}EVENTS.bind(document,"SMILTimesheetLoaded",CountTimesheets);for(i=0;i<tsLength;i++){if(window.ActiveXObject){var xhr=new ActiveXObject("Microsoft.XMLHTTP");xhr.open("GET",timesheets[i].href,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){var xmlDoc=new ActiveXObject("Microsoft.XMLDOM");xmlDoc.loadXML(xhr.responseText);var tsNodes=xmlDoc.getElementsByTagName("timesheet");if(tsNodes&&tsNodes.length){parseTimesheetNode(tsNodes[0])}EVENTS.trigger(document,"SMILTimesheetLoaded")}};xhr.send(null)}else{if(window.XMLHttpRequest){var xhr=new XMLHttpRequest();xhr.open("GET",timesheets[i].href,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){xhr.overrideMimeType("text/xml");var tsNodes=xhr.responseXML.getElementsByTagName("timesheet");if(tsNodes&&tsNodes.length){parseTimesheetNode(tsNodes[0])}EVENTS.trigger(document,"SMILTimesheetLoaded")}};xhr.send(null)}else{EVENTS.trigger(document,"SMILTimesheetLoaded")}}}if(!OLDIE){var docElt=document.documentElement;function nsResolver(prefix){var ns={xhtml:docElt.getAttribute("xmlns"),smil:docElt.getAttribute("xmlns:smil")};return ns[prefix]||null}var TimesheetNS=nsResolver("smil");timesheets=document.getElementsByTagNameNS(TimesheetNS,"timesheet");for(i=0;i<timesheets.length;i++){parseTimesheetNode(timesheets[i])}if(docElt.getAttribute("xmlns")&&docElt.getAttribute("xmlns:smil")){consoleLog("document has SMIL extensions: "+nsResolver("smil"));var containers=document.evaluate("//*[@smil:timeContainer]",document,nsResolver,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);var thisContainer=containers.iterateNext();try{while(thisContainer){parseTimeContainerNode(thisContainer);thisContainer=containers.iterateNext()}}catch(e){consoleLog(e.toString())}}}EVENTS.trigger(document,"SMILTimesheetLoaded")}EVENTS.onDOMReady(function(){consoleLog("SMIL/HTML Timing: startup");parseAllTimeContainers()});function smilInternalTimer(timerate){if(!timerate){timerate=TIMERATE}var self=this;this.onTimeUpdate=null;var timerID=null;var timeStart=0;var timePause=0;var paused=true;this.isPaused=function(){return paused};this.getTime=function(){var ms=timePause;if(!paused){ms+=Date.now()-timeStart}return(ms/1000)};this.setTime=function(time){timeStart-=(time-self.getTime())*1000};this.Play=function(){if(!paused){return}timeStart=Date.now();timerID=setInterval(function(){self.onTimeUpdate()},timerate);paused=false;consoleLog("started: "+timerID)};this.Pause=function(){if(paused){return}clearInterval(timerID);timerID=null;timePause=1000*self.getTime();paused=true;self.onTimeUpdate();consoleLog("paused: "+timerID)};this.Stop=function(){if(!timerID){return}clearInterval(timerID);timerID=null;timePause=0;paused=true;self.onTimeUpdate();consoleLog("stopped: "+timerID)}}function smilExternalTimer(mediaPlayerNode){var self=this;this.onTimeUpdate=null;this.isPaused=function(){return mediaPlayerNode.paused};this.getTime=function(){return mediaPlayerNode.currentTime};this.setTime=function(time){try{mediaPlayerNode.currentTime=time}catch(e){consoleLog("seeking to time="+time+"...");consoleLog("  readyState = "+mediaPlayerNode.readyState);function setThisTime(){mediaPlayerNode.currentTime=time;mediaPlayerNode.removeEventListener("canplay",setThisTime,true);consoleLog("  readyState = "+mediaPlayerNode.readyState)}mediaPlayerNode.addEventListener("canplay",setThisTime,true)}};this.Play=function(){if(!OLDIE){mediaPlayerNode.addEventListener("timeupdate",self.onTimeUpdate,true)}};this.Pause=function(){mediaPlayerNode.pause()};this.Stop=function(){mediaPlayerNode.removeEventListener("timeupdate",self.onTimeUpdate,true)}}smilTimeItem.prototype.getNode=function(){};smilTimeItem.prototype.parseTime=function(timeStr){if(!timeStr||!timeStr.length){return undefined}else{if(timeStr=="indefinite"){return Infinity}else{if(/ms[\s]*$/.test(timeStr)){return parseFloat(timeStr)/1000}else{if(/s[\s]*$/.test(timeStr)){return parseFloat(timeStr)}else{if(/min[\s]*$/.test(timeStr)){return parseFloat(timeStr)*60}else{if(/h[\s]*$/.test(timeStr)){return parseFloat(timeStr)*3600}else{if(/^[0-9:\.]*$/.test(timeStr)){var seconds=0;var tmp=timeStr.split(":");for(var i=0;i<tmp.length;i++){seconds=(seconds*60)+parseFloat(tmp[i])}return seconds}else{return timeStr}}}}}}}};smilTimeItem.prototype.parseEvent=function(eventStr,callback){if(!eventStr||!eventStr.length){return}var tmp=eventStr.split(".");if(tmp.length>=2){var target=document.getElementById(tmp[0]);var evt=tmp[1]}else{var target=this.getNode();var evt=eventStr}if(target){EVENTS.bind(target,evt,callback)}return target};smilTimeItem.prototype.parseEvents=function(eventStr,callback){var events=new Array();if(!eventStr||!eventStr.length||!isNaN(eventStr)){return events}var tmp=eventStr.split(".");if(tmp.length>=2){var target=document.getElementById(tmp[0]);var evt=tmp[1]}else{var target=this.getNode();var evt=eventStr}events.push({target:target,event:evt});return events};smilTimeItem.prototype.parseAttribute=function(attrName,dValue){var node=this.getNode();var nodeName=node.nodeName.replace(/^smil:/,"");var value="";if((attrName=="timeContainer")&&(/^(seq|par|excl)$/i).test(nodeName)){value=nodeName}else{if(node.getAttribute(attrName)){value=node.getAttribute(attrName)}else{if(node.getAttribute("smil:"+attrName)){value=node.getAttribute("smil:"+attrName)}else{value=node.getAttribute("data-"+attrName.toLowerCase())}}}if(!value||!value.length){return dValue}switch(attrName){case"timeContainer":case"timeAction":return value.toLowerCase();case"repeatCount":return(value=="indefinite")?Infinity:parseFloat(value);case"onbegin":case"onend":return function(){eval(value)};case"beginInc":case"begin":case"dur":case"end":case"repeatDur":return this.parseTime(value);default:return value}};smilTimeItem.prototype.newTargetHandler=function(timeAction,target){if(!target){return function(state){}}var setTargetState_intrinsic=function(state){target.setAttribute("smil",state)};var setTargetState_display=function(state){target.style.display=(state=="active")?"block":"none"};var setTargetState_visibility=function(state){target.style.visibility=(state=="active")?"visible":"hidden"};var setTargetState_style=function(state){var active=(state=="active");if(!target._smilstyle){target._smilstyle=target.style.cssText}target.style.cssText=active?target._smilstyle:""};var setTargetState_class=function(state){var active=(state=="active");if(!target._smilclass_active){var activeCN=target.className+(target.className.length?" ":"")+timeAction.replace(/class:[\s]*/,"");target._smilclass_active=activeCN;target._smilclass_idle=target.className}target.className=active?target._smilclass_active:target._smilclass_idle};switch(timeAction){case"display":return setTargetState_display;break;case"visibility":return setTargetState_visibility;break;case"style":return setTargetState_style;break;default:if(/^class:/.test(timeAction)){return setTargetState_class}else{if(OLDIE){return setTargetState_visibility}else{return setTargetState_intrinsic}}break}};smilTimeItem.prototype.addEventListener=function(events,callback){for(var i=0;i<events.length;i++){var evt=events[i];if(evt.target){EVENTS.bind(evt.target,evt.event,callback)}}};smilTimeItem.prototype.removeEventListener=function(events,callback){for(var i=0;i<events.length;i++){var evt=events[i];if(evt.target){EVENTS.unbind(evt.target,evt.event,callback)}}};smilTimeItem.prototype.dispatchEvent=function(eventType){var func=this["on"+eventType];EVENTS.trigger(this.target,eventType);if(func){func.call(this.target)}};function smilTimeItem(domNode,parentNode,targetNode){var self=this;this.parseTime=smilTimeItem.prototype.parseTime;this.parseEvent=smilTimeItem.prototype.parseEvent;this.parseEvents=smilTimeItem.prototype.parseEvents;this.parseAttribute=smilTimeItem.prototype.parseAttribute;this.parentNode=parentNode;this.previousSibling=null;this.nextSibling=null;this.timeNodes=null;this.getNode=function(){return domNode};this.target=targetNode||domNode;if(/^(par|seq|excl)$/i.test(this.target.nodeName)){this.target=null}var timeAction=parentNode?parentNode.timeAction:"intrinsic";this.timeAction=this.parseAttribute("timeAction",timeAction);this.timeContainer=this.parseAttribute("timeContainer",null);this.begin=this.parseAttribute("begin");this.dur=this.parseAttribute("dur");this.end=this.parseAttribute("end");var fillDefault=parentNode?parentNode.fillDefault:"remove";this.fill=this.parseAttribute("fill",fillDefault);this.setTargetState=smilTimeItem.prototype.newTargetHandler.call(this,this.timeAction,this.target);this.addEventListener=smilTimeItem.prototype.addEventListener;this.removeEventListener=smilTimeItem.prototype.removeEventListener;this.dispatchEvent=smilTimeItem.prototype.dispatchEvent;this.onbegin=this.parseAttribute("onbegin");this.onend=this.parseAttribute("onend");var beginEvents=this.parseEvents(this.begin);var endEvents=this.parseEvents(this.end);var onbeginListener=function(){consoleLog("onbeginListener");self.time_in=self.parentNode.getTime();self.time_out=isNaN(self.end)?Infinity:self.end;self.parentNode.selectItem(self)};var onendListener=function(){consoleLog("onendListener");self.time_in=isNaN(self.begin)?Infinity:self.begin;self.time_out=self.parentNode.getTime();self.parentNode.currentIndex=-1;self.hide()};var state="";this.isActive=function(){return(state=="active")};this.show=function(){if(state=="active"){return}state="active";self.setTargetState(state);self.dispatchEvent("begin");self.addEventListener(endEvents,onendListener);self.removeEventListener(beginEvents,onbeginListener);if(self.parentNode.timeContainer=="excl"){consoleLog("show")}};this.hide=function(){if(state=="done"){return}state="done";if(self.fill!="hold"){self.setTargetState(state)}self.dispatchEvent("end");self.addEventListener(beginEvents,onbeginListener);self.removeEventListener(endEvents,onendListener)};this.reset=function(){if(state=="idle"){return}state="idle";self.setTargetState(state);self.addEventListener(beginEvents,onbeginListener);self.removeEventListener(endEvents,onendListener);if(self.parentNode.timeContainer=="excl"){consoleLog("reset")}};try{domNode.timing=this}catch(e){domNode.setAttribute("timing",this)}}smilTimeContainer_generic.prototype.getTime=function(){};smilTimeContainer_generic.prototype.setTime=function(){};smilTimeContainer_generic.prototype.onTimeUpdate=function(){};smilTimeContainer_generic.prototype.parseTimeNodes=function(){var timeNodes=new Array();var syncMasterNode=null;var children=this.getNode().childNodes;for(var i=0;i<children.length;i++){var segment=children[i];var targets=new Array();if(segment.nodeType==1){if(segment.timing||segment.getAttribute("timing")){consoleLog("!! "+segment.nodeName+" is already initialized !!");alert("!! "+segment.nodeName+" is already initialized !!")}else{if(/item$/i.test(segment.nodeName)){var select=segment.getAttribute("select")||segment.getAttribute("smil:select");targets=document.querySelectorAll(select)}else{targets.push(segment)}}for(var j=0;j<targets.length;j++){var target=targets[j];var node=null;if(segment!=target){node=new smilTimeItem(segment,this,target);var beginInc=node.parseAttribute("beginInc");if(isNaN(node.begin)&&!isNaN(beginInc)){node.begin=j*beginInc}}else{node=new smilTimeElement(segment,this)}if(node.parseAttribute("syncMaster")){syncMasterNode=target}if(node.timeAction!="none"){timeNodes.push(node)}else{delete (node)}}}}for(i=0;i<timeNodes.length;i++){var segment=timeNodes[i];if(i>0){segment.previousSibling=timeNodes[i-1]}if(i<timeNodes.length-1){segment.nextSibling=timeNodes[i+1]}segment.parentNode=this}if(this.dur==undefined){if(!isNaN(this.end-this.begin)){this.dur=this.end-this.begin}else{this.dur=Infinity}}return{timeNodes:timeNodes,syncMasterNode:syncMasterNode}};smilTimeContainer_generic.prototype.computeTimeNodes=function(){};smilTimeContainer_generic.prototype.getMediaSync=function(syncMasterNode){var mediaSyncSelector=this.parseAttribute("mediaSync");var mediaSyncNode=document.querySelector(mediaSyncSelector);return mediaSyncNode||syncMasterNode};smilTimeContainer_generic.prototype.currentIndex=-1;smilTimeContainer_generic.prototype.checkIndex=function(index){var state=(this.currentIndex>0)?"active":"idle";if(this.first&&!this.first.timing){this.first.setAttribute("smil",state)}if(this.prev&&!this.prev.timing){this.prev.setAttribute("smil",state)}state=(this.currentIndex<this.timeNodes.length-1)?"active":"idle";if(this.next&&!this.next.timing){this.next.setAttribute("smil",state)}if(this.last&&!this.last.timing){this.last.setAttribute("smil",state)}};smilTimeContainer_generic.prototype.selectIndex=function(index){if((index>=0)&&(index<this.timeNodes.length)&&(index!=this.currentIndex)){consoleLog("current index: "+this.currentIndex);var time=this.timeNodes[index].time_in;if(!isNaN(time)&&(time<Infinity)){consoleLog("hashchange: set time to "+time);if(this.mediaSyncNode){this.setTime(time+0.1);this.onTimeUpdate();return}else{this.setTime(time)}}this.currentIndex=index;this.timeNodes[index].show();for(var i=0;i<index;i++){this.timeNodes[i].hide()}for(i=index+1;i<this.timeNodes.length;i++){this.timeNodes[i].reset()}consoleLog("new index: "+this.currentIndex);this.checkIndex()}};smilTimeContainer_generic.prototype.selectItem=function(item){var index=this.timeNodes.indexOf(item);this.selectIndex(index)};function smilTimeContainer_generic(timeContainerNode,parentNode,timerate){this.parseTimeNodes=smilTimeContainer_generic.prototype.parseTimeNodes;this.getMediaSync=smilTimeContainer_generic.prototype.getMediaSync;var self=this;this.repeatCount=this.parseAttribute("repeatCount",1);this.repeatDur=this.parseAttribute("repeatDur",NaN);consoleLog("  initializing: "+this.timeContainer+" ("+this.getNode().nodeName+")");var result=this.parseTimeNodes();this.timeNodes=result.timeNodes;this.computeTimeNodes();if(true){consoleLog("  time container: "+this.timeContainer+" ("+this.getNode().nodeName+")");for(var i=0;i<this.timeNodes.length;i++){consoleLog("    timeNodes["+i+"]: "+this.timeNodes[i].time_in+" => "+this.timeNodes[i].time_out)}}this.mediaSyncNode=this.getMediaSync(result.syncMasterNode);var timer=(this.mediaSyncNode)?new smilExternalTimer(this.mediaSyncNode):new smilInternalTimer(timerate);this.isPaused=timer.isPaused;this.getTime=timer.getTime;this.setTime=timer.setTime;this.Play=timer.Play;this.Pause=timer.Pause;this.Stop=timer.Stop;timer.onTimeUpdate=function(){self.onTimeUpdate()};var state="";this.isActive=function(){return(state=="active")};this.show=function(){if(state=="active"){return}state="active";self.Play();self.setTargetState(state);this.currentIndex=-1};this.hide=function(){if(state=="done"){return}state="done";self.Stop();self.setTargetState(state);for(var i=0;i<self.timeNodes.length;i++){self.timeNodes[i].hide();if(self.timeNodes[i].fill=="hold"){self.timeNodes[i].setTargetState("done")}}};this.reset=function(){if(state=="idle"){return}state="idle";self.Stop();self.setTargetState(state);for(var i=0;i<self.timeNodes.length;i++){self.timeNodes[i].reset()}this.currentIndex=-1}}smilTimeContainer_par.prototype.computeTimeNodes=function(){for(var i=0;i<this.timeNodes.length;i++){var segment=this.timeNodes[i];segment.reset();if(segment.begin!=undefined){segment.time_in=isNaN(segment.begin)?Infinity:segment.begin}else{segment.time_in=0}if(segment.dur!=undefined){segment.time_out=segment.time_in+segment.dur}else{if(segment.end!=undefined){segment.time_out=isNaN(segment.end)?Infinity:segment.end}else{segment.time_out=this.dur}}}};smilTimeContainer_par.prototype.onTimeUpdate=function(){var time=this.getTime();if(this.repeatCount>=Infinity){time=time%this.dur}for(var i=0;i<this.timeNodes.length;i++){if(time<this.timeNodes[i].time_in){this.timeNodes[i].reset()}else{if(time>=this.timeNodes[i].time_out){this.timeNodes[i].hide()}else{this.timeNodes[i].show()}}}};function smilTimeContainer_par(domNode,parentNode,timerate){this.computeTimeNodes=smilTimeContainer_par.prototype.computeTimeNodes;this.onTimeUpdate=smilTimeContainer_par.prototype.onTimeUpdate;smilTimeContainer_generic.call(this,domNode,timerate);this.currentIndex=-1;this.checkIndex=function(index){};this.selectIndex=function(index){};this.selectItem=function(item){if(!isNaN(item.time_in)){this.setTime(item.time_in)}item.show()}}smilTimeContainer_excl.prototype.computeTimeNodes=function(){var segment=null;for(i=0;i<this.timeNodes.length;i++){segment=this.timeNodes[i];segment.reset();if(segment.begin!=undefined){segment.time_in=isNaN(segment.begin)?Infinity:segment.begin}else{segment.time_in=Infinity}if(segment.end!=undefined){segment.time_out=isNaN(segment.end)?Infinity:segment.end}else{if((i<this.timeNodes.length-1)&&!isNaN(this.timeNodes[i+1].begin)){segment.time_out=this.timeNodes[i+1].begin}else{if(!isNaN(segment.dur)){segment.time_out=segment.time_in+segment.dur}else{segment.time_out=this.dur}}}}if(!segment){return}if(!this.timeNodes[0].time_in){this.timeNodes[0].show()}if(this.dur==undefined){this.dur=segment.time_out-this.timeNodes[0].time_in}};smilTimeContainer_excl.prototype.onTimeUpdate=function(){var time=this.getTime();if(this.repeatCount>=Infinity){time=time%this.dur}if(this.currentIndex>=0){var time_in=this.timeNodes[this.currentIndex].time_in;var time_out=this.timeNodes[this.currentIndex].time_out;var outOfBounds=(time<time_in)||(time>=time_out);if(!outOfBounds){return}}var index=-1;var active=false;for(var i=0;i<this.timeNodes.length;i++){var segment=this.timeNodes[i];var withinBounds=(time>=segment.time_in)&&(time<segment.time_out);if(time<segment.time_in){segment.reset()}else{if(time>=segment.time_out){segment.hide()}else{if(withinBounds){if(active){segment.reset()}else{active=true;segment.show();index=i}}}}}if(index>=0){this.currentIndex=index;this.checkIndex()}else{if((this.currentIndex<this.timeNodes.length-1)&&isNaN(this.timeNodes[this.currentIndex+1].time_in)){consoleLog("excl index = "+this.currentIndex);this.selectIndex(this.currentIndex+1)}}};function smilTimeContainer_excl(domNode,parentNode,timerate){this.computeTimeNodes=smilTimeContainer_excl.prototype.computeTimeNodes;this.onTimeUpdate=smilTimeContainer_excl.prototype.onTimeUpdate;smilTimeContainer_generic.call(this,domNode,parentNode,timerate);var self=this;this.currentIndex=-1;if(this.timeNodes.length&&(this.timeNodes[0].time_in<=0)){this.currentIndex=0}this.checkIndex=smilTimeContainer_generic.prototype.checkIndex;this.selectIndex=smilTimeContainer_generic.prototype.selectIndex;this.selectItem=smilTimeContainer_generic.prototype.selectItem;this.first=this.parseEvent(this.parseAttribute("first"),function(){self.selectIndex(0)});this.prev=this.parseEvent(this.parseAttribute("prev"),function(){self.selectIndex(self.currentIndex-1)});this.next=this.parseEvent(this.parseAttribute("next"),function(){self.selectIndex(self.currentIndex+1)});this.last=this.parseEvent(this.parseAttribute("last"),function(){self.selectIndex(self.timeNodes.length-1)});this.checkIndex()}smilTimeContainer_seq.prototype.computeTimeNodes=function(){var segment=null;for(var i=0;i<this.timeNodes.length;i++){segment=this.timeNodes[i];segment.reset();if(segment.begin!=undefined){segment.time_in=segment.begin}else{if((i>0)&&(this.timeNodes[i-1].time_out<Infinity)){segment.time_in=this.timeNodes[i-1].time_out}else{segment.time_in=0}}if(!isNaN(segment.dur)){segment.time_out=segment.time_in+segment.dur}else{if(i==this.timeNodes.length-1){segment.time_out=this.dur}else{segment.time_out=Infinity}}}if(!segment){return}if((this.dur==undefined)||(this.dur>=Infinity)){this.dur=segment.time_out}if(this.end==undefined){this.end=segment.time_out+this.begin}};smilTimeContainer_seq.prototype.onTimeUpdate=function(){var time=this.getTime();if(this.repeatCount>=Infinity){time=time%this.dur}if(this.currentIndex>=0){var segment=this.timeNodes[this.currentIndex];var outOfBounds=(time<segment.time_in)||(time>=segment.time_out);var withinBounds=(time>=segment.time_in)&&(time<segment.time_out);if(withinBounds){return}else{this.timeNodes[this.currentIndex].hide()}}if(this.currentIndex<this.timeNodes.length-1){var time_in=this.timeNodes[this.currentIndex+1].time_in;var time_out=this.timeNodes[this.currentIndex+1].time_out;var outOfBounds=(time<time_in)||(time>=time_out);if((time_in>=Infinity)||!outOfBounds){this.currentIndex++;this.timeNodes[this.currentIndex].show();this.checkIndex();return}}var index=-1;var active=false;for(var i=0;i<this.timeNodes.length;i++){var segment=this.timeNodes[i];var withinBounds=(time>=segment.time_in)&&(time<segment.time_out);if(time<segment.time_in){segment.reset()}else{if(time>=segment.time_out){segment.hide()}else{if(withinBounds){if(active){segment.reset()}else{active=true;segment.show();index=i}}}}}if(index>=0){this.currentIndex=index;this.checkIndex()}else{if((this.currentIndex<this.timeNodes.length-1)&&isNaN(this.timeNodes[this.currentIndex+1].time_in)){this.next()}}};function smilTimeContainer_seq(domNode,parentNode,timerate){this.computeTimeNodes=smilTimeContainer_seq.prototype.computeTimeNodes;this.onTimeUpdate=smilTimeContainer_seq.prototype.onTimeUpdate;smilTimeContainer_generic.call(this,domNode,parentNode,timerate);var self=this;this.currentIndex=-1;if(this.timeNodes.length&&(this.timeNodes[0].time_in<=0)){this.currentIndex=0}this.checkIndex=smilTimeContainer_generic.prototype.checkIndex;this.selectIndex=smilTimeContainer_generic.prototype.selectIndex;this.selectItem=smilTimeContainer_generic.prototype.selectItem;this.first=this.parseEvent(this.parseAttribute("first"),function(){self.selectIndex(0)});this.prev=this.parseEvent(this.parseAttribute("prev"),function(){self.selectIndex(self.currentIndex-1)});this.next=this.parseEvent(this.parseAttribute("next"),function(){self.selectIndex(self.currentIndex+1)});this.last=this.parseEvent(this.parseAttribute("last"),function(){self.selectIndex(self.timeNodes.length-1)});this.checkIndex()}function smilTimeElement(domNode,parentNode,timerate){smilTimeItem.call(this,domNode,parentNode);switch(this.timeContainer){case"par":smilTimeContainer_par.call(this,domNode,parentNode,timerate);break;case"seq":smilTimeContainer_seq.call(this,domNode,parentNode,timerate);break;case"excl":smilTimeContainer_excl.call(this,domNode,parentNode,timerate);break;default:this.timeContainer=null;this.timeNodes=new Array()}if(this.timeContainer){consoleLog("  "+this.timeContainer+" ("+domNode.nodeName+") properly initialized.")}}})();
